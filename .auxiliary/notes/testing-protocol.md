# Sphinx MCP Server - Development and Testing Guide

## Overview

This document describes the development workflow for the Sphinx MCP Server using reloaderoo for hot-reloading.

## Development Setup with Reloaderoo

The primary development method uses **reloaderoo** for transparent hot-reloading:

### Claude Code Configuration

Configure `.auxiliary/configuration/mcp-servers.json`:

```json
{
  "mcpServers": {
    "sphinx": {
      "command": "reloaderoo",
      "args": [
        "--",
        "hatch",
        "run",
        "sphinxmcps",
        "--logfile",
        ".auxiliary/inscriptions/server.txt",
        "serve"
      ]
    }
  }
}
```

### Hot-Reload Workflow

1. **Start Claude Code** with the reloaderoo configuration
2. **Make code changes** to the server implementation  
3. **Use the `restart_server` tool** to reload changes:
   - "Please restart the server to pick up my code changes"
   - Claude Code will call the `restart_server` tool automatically
4. **Test immediately** - no session loss or reconnection needed

### Key Advantages

- ✅ **Session continuity preserved** - No broken MCP protocol handshakes
- ✅ **Manual control** - Restart exactly when needed, not on every file change  
- ✅ **Transparent proxying** - No complex TCP bridging or external tools
- ✅ **Immediate testing** - Tools work immediately after restart
- ✅ **Simple architecture** - No custom subprocess management

## Server Monitoring

Monitor server activity via the configured log file:

```bash
tail -f .auxiliary/inscriptions/server.txt
```

Typical log entries show:
```text
sphinxmcps.server: Initializing FastMCP server
sphinxmcps.server: Registering extract_inventory tool
sphinxmcps.server: Registering summarize_inventory tool
mcp.server.lowlevel.server: Processing request of type CallToolRequest
sphinxmcps.server: extract_inventory called: source=..., domain=..., role=..., term=...
```

## Testing Guidelines

### ⚠️ Important: Avoid Large Inventory Dumps

**DO NOT** dump entire inventories from large sites like `python.org` during testing:
- ❌ **Avoid**: `extract_inventory` with minimal filtering on large sites
- ❌ **Avoid**: JSON output of complete inventories from major documentation sites
- ✅ **Prefer**: Local inventories generated by `hatch --env develop run docsgen`
- ✅ **Prefer**: Highly filtered results (`domain` + `role` + `term` filters)
- ✅ **Prefer**: Summary output format for large inventories

### Recommended Test Sources

1. **Local inventory** (preferred for development):
   ```bash
   # Generate local docs first
   hatch --env develop run docsgen
   # Use local inventory
   ".auxiliary/artifacts/sphinx-html"
   ```

2. **Small external inventories**:
   - `https://sphobjinv.readthedocs.io/en/latest` (220 objects)
   - Other smaller documentation sites

3. **Filtered large inventories** (when testing filters):
   - Use domain + role + term filters for small result sets
   - Use summary format, not extract format for large sites

## Regex Pattern Examples

The `regex=true` parameter enables powerful pattern-based filtering:

### Basic Patterns
- **Contains**: `term=".*inventory.*", regex=true` - Objects containing "inventory"
- **Prefix**: `term="^extract", regex=true` - Objects starting with "extract"  
- **Suffix**: `term=".*_file$", regex=true` - Objects ending with "_file"

### Advanced Patterns
- **Alternation**: `term="^(data|json)_.*", regex=true` - Objects starting with "data_" or "json_"
- **Character classes**: `term="[A-Z][a-z]+Error$", regex=true` - Exception classes
- **Quantifiers**: `term="get_.{1,10}_config", regex=true` - Getter methods with specific patterns

### Common Use Cases
```python
# Find all exception classes
extract_inventory(source, domain="py", role="class", term=".*Error$", regex=True)

# Find private methods
extract_inventory(source, domain="py", role="method", term="^_[^_]", regex=True)

# Find configuration functions
extract_inventory(source, term="(config|settings)", regex=True)
```

## Development Workflow Benefits

This reloaderoo-based infrastructure enables:
- ✅ **Rapid iteration** on tool development
- ✅ **Immediate feedback** on code changes
- ✅ **No Claude Code restarts** required
- ✅ **Full MCP protocol validation**
- ✅ **Easy debugging** with persistent logging
- ✅ **Warm reload** on demand via `restart_server` tool

## Alternative Development Setup

For standalone testing without Claude Code, the server can be run directly:

```bash
# Standard stdio mode
hatch run sphinxmcps serve

# SSE mode on custom port  
hatch run sphinxmcps serve --transport sse --port 8000
```

However, the reloaderoo + Claude Code approach is preferred for development iteration.