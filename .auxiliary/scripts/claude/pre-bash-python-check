#!/usr/bin/env python3
# vim: set filetype=python fileencoding=utf-8:
# -*- coding: utf-8 -*-

''' Claude Code hook to detect direct python usage in Bash commands. '''

import json
import re
import sys


# Compile regex once for efficiency
_PYTHON_PATTERN = re.compile( r'\b(?:python|python3|python3\.\d+)\b' )


def main( ):
    ''' Main entry point for the Python usage check hook. '''
    # Read hook event JSON from stdin
    try:
        event_data = json.load( sys.stdin )
    except json.JSONDecodeError:
        print( "Error: Invalid JSON input", file = sys.stderr )
        sys.exit( 2 )
    
    # Only check Bash tool usage
    tool_name = event_data.get( 'tool_name', '' )
    if tool_name != 'Bash':
        sys.exit( 0 )
    
    # Get the command from tool input
    tool_input = event_data.get( 'tool_input', { } )
    command = tool_input.get( 'command', '' )
    
    # Check for direct python usage patterns
    if _PYTHON_PATTERN.search( command ):
        # Check if it's already using hatch
        if 'hatch' in command:
            sys.exit( 0 )
        
        print(
            f"Warning: Direct Python usage detected in command: {command}\n"
            f"Consider using 'hatch run python' or "
            f"'hatch --env develop run python' to ensure dependencies "
            f"are available.",
            file = sys.stderr
        )
        # Exit with code 2 to show warning to Claude
        sys.exit( 2 )
    
    # No issues found
    sys.exit( 0 )


if __name__ == '__main__':
    main()